---
type NavLink = { href: string; label: string };

const { transparent = false } = Astro.props as { transparent?: boolean };
const isActive = (href: string) => Astro.url.pathname === href;

// SSR: detectar cookie qrauth o ruta /privado
const rawCookie = Astro.request.headers.get('cookie') || '';
const hasQRCookie = /\bqrauth=/.test(rawCookie);
const showProductosSSR = Astro.url.pathname === '/privado' || hasQRCookie;

const baseLinks: NavLink[] = [
  { href: '/', label: 'Home' },
  { href: '/valores', label: 'Valores' },
  { href: '/industrias', label: 'Industrias' },
  { href: '/historia', label: 'Historia' },
  { href: '/contacto', label: 'Contacto' },
];
const otherLinks = baseLinks.filter(l => l.href !== '/');
---

<header
  id="siteHeader"
  class={`${transparent ? 'fixed' : 'sticky'} inset-x-0 top-0 z-50 border-b transition-all duration-300
          ${transparent ? 'bg-transparent text-white border-transparent' : 'bg-white/85 text-slate-800 backdrop-blur-md border-slate-200 shadow-sm'}`}
>
  <div class="mx-auto max-w-7xl px-6 h-24 md:h-28 flex items-center justify-between">
    <a href="/" class="inline-flex items-center gap-4" aria-label="Inbolsa">
      <img
        id="siteLogo"
        src={transparent ? '/logo.png' : '/Black.png'}
        data-logo-white="/logo.png"
        data-logo-black="/Black.png"
        alt="Inbolsa"
        class="h-20 md:h-20 w-auto transition-opacity duration-300"
      />
      <span class="sr-only">Inbolsa</span>
    </a>

    <nav class="hidden md:flex items-center gap-8 text-base md:text-lg">
      {(() => {
        const l = { href: '/', label: 'Home' };
        const active = isActive(l.href);
        return (
          <a
            href={l.href}
            aria-current={active ? 'page' : undefined}
            class={`${transparent
                ? `relative pb-1 hover:opacity-90 ${active ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
                : `hover:text-brand-700 ${active ? 'text-brand-700 font-medium' : ''}`
              }`}
          >
            {l.label}
          </a>
        );
      })()}

      {/* Productos: oculto hasta que haya cookie qrauth o estemos en /privado */}
      <a
        href="/productos"
        data-nav-products
        aria-current={isActive('/productos') ? 'page' : undefined}
        class={`${showProductosSSR ? '' : 'hidden'} ${transparent
            ? `relative pb-1 hover:opacity-90 ${isActive('/productos') ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
            : `hover:text-brand-700 ${isActive('/productos') ? 'text-brand-700 font-medium' : ''}`
          }`}
      >
        Productos
      </a>

      {otherLinks.map((l) => {
        const active = isActive(l.href);
        return (
          <a
            href={l.href}
            aria-current={active ? 'page' : undefined}
            class={`${transparent
                ? `relative pb-1 hover:opacity-90 ${active ? 'after:absolute after:left-0 after:right-0 after:-bottom-0.5 after:h-0.5 after:bg-white/70' : ''}`
                : `hover:text-brand-700 ${active ? 'text-brand-700 font-medium' : ''}`
              }`}
          >
            {l.label}
          </a>
        );
      })}

      <a
        id="ctaHeader"
        href="/contacto"
        class={`${transparent
          ? 'rounded-2xl border border-white/70 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 md:px-6 md:py-3 transition'
          : 'rounded-2xl bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 md:px-6 md:py-3 transition'
        }`}
      >
        Contáctanos
      </a>
    </nav>
  </div>

  {transparent && (
    <script is:inline>
      const header = document.getElementById('siteHeader');
      const logo   = document.getElementById('siteLogo');
      const cta    = document.getElementById('ctaHeader');

      const whiteSrc = logo && logo.getAttribute('data-logo-white');
      const blackSrc = logo && logo.getAttribute('data-logo-black');

      function setSolid(s) {
        if (!header) return;

        if (s) {
          header.classList.add('bg-white/85','backdrop-blur-md','text-slate-800','border-slate-200','shadow-sm');
          header.classList.remove('bg-transparent','text-white','border-transparent');
          if (logo && blackSrc) logo.setAttribute('src', blackSrc);
          if (cta) cta.className = 'rounded-2xl bg-brand-600 hover:bg-brand-700 text-white px-5 py-2.5 md:px-6 md:py-3 transition';
        } else {
          header.classList.add('bg-transparent','text-white','border-transparent');
          header.classList.remove('bg-white/85','backdrop-blur-md','text-slate-800','border-slate-200','shadow-sm');
          if (logo && whiteSrc) logo.setAttribute('src', whiteSrc);
          if (cta) cta.className = 'rounded-2xl border border-white/70 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 md:px-6 md:py-3 transition';
        }
      }

      const onScroll = () => setSolid(window.scrollY > 16);
      onScroll();
      window.addEventListener('scroll', onScroll, { passive: true });
    </script>
  )}

  <!-- Lógica privada "simple": mostrar Productos si hay cookie qrauth o estamos en /privado -->
  <script is:inline data-nav-products-logic>
    (function() {
      try {
        var link = document.querySelector('[data-nav-products]');
        if (!link) return;

        var hasQr = document.cookie.indexOf('qrauth=') !== -1;
        var onPrivate = location.pathname === '/privado';
        if (hasQr || onPrivate) {
          link.classList.remove('hidden');
        } else {
          link.classList.add('hidden');
        }
      } catch (e) {}
    })();
  </script>
</header>
