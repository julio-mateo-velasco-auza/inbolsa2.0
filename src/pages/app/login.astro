---
export const prerender = true;
import Base from '../../layouts/Base.astro';
---

<Base title="Inbolsa · App · Login">
  <section class="min-h-dvh grid place-items-center p-6">
    <form id="f" class="w-full max-w-md rounded-2xl border bg-white p-6 shadow-sm">
      <h1 class="text-2xl font-semibold">Iniciar sesión</h1>
      <p class="text-slate-600 text-sm mt-1">Acceso privado para generar y gestionar QR.</p>

      <label class="mt-6 block text-sm">Correo</label>
      <input id="email" type="email" required placeholder="admin@inbolsa.com"
             class="mt-1 w-full rounded-xl border px-4 py-3" />

      <label class="mt-4 block text-sm">Contraseña</label>
      <input id="password" type="password" required
             class="mt-1 w-full rounded-xl border px-4 py-3" />

      <button class="mt-6 w-full rounded-xl bg-blue-600 px-4 py-3 font-semibold text-white hover:bg-blue-700 transition">
        Entrar
      </button>

      <div id="msg" class="mt-3 text-sm text-red-600"></div>
    </form>
  </section>

  <script type="module">
    // Lee los valores inyectados por el layout (SIEMPRE presentes)
    const html  = document.documentElement;
    const BASE  = html.getAttribute('data-base') || '';
    const API   = html.getAttribute('data-api')  || (BASE + '/api');
    const ORIGIN = location.origin; // http://localhost

    const form = document.getElementById('f');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Ingresando…';

      try {
        const res = await fetch(ORIGIN + API + '/auth/login', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.value, password: password.value })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.ok) {
          msg.textContent = data?.error || 'Credenciales inválidas';
          return;
        }

        const next = new URLSearchParams(location.search).get('next') || (BASE + '/app/panel');
        location.replace(next);
      } catch (err) {
        msg.textContent = 'No se pudo iniciar sesión.';
      }
    });
  </script>
</Base>
