---
/** 👇 TODO lo “export …” va SIEMPRE dentro de este bloque */
export const prerender = true;

import Boot from '../../components/Boot.astro';

// Si necesitas el "next" para redirigir:
const url = new URL(Astro.request.url);
const next = url.searchParams.get('next') || `${import.meta.env.BASE_URL}app/panel`;
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Iniciar sesión — Inbolsa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <Boot />
  </head>
  <body>
    <main class="mx-auto max-w-md px-4 py-16">
      <h1 class="text-2xl font-semibold">Iniciar sesión</h1>
      <p id="msg" class="mt-2 text-slate-600">Ingresa tus credenciales.</p>

      <form id="loginForm" class="mt-6 space-y-4">
        <div>
          <label class="block text-sm">Email</label>
        <input id="email" type="email" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div>
          <label class="block text-sm">Password</label>
          <input id="password" type="password" required class="w-full border px-3 py-2 rounded" />
        </div>
        <button id="btn" type="submit" class="w-full border px-3 py-2 rounded">Entrar</button>
      </form>
    </main>

    <script type="module">
      // BASE/API vienen del boot (same-origin, sin CORS)
      const BASE = (window.__BASE ?? import.meta.env.BASE_URL.replace(/\/$/, ''));
      const API  = (window.__API  ?? (BASE + '/api'));
      const nextUrl = new URLSearchParams(location.search).get('next') || (BASE + '/app/panel');

      const $f = document.getElementById('loginForm');
      const $msg = document.getElementById('msg');
      const $btn = document.getElementById('btn');

      $f.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        $btn.disabled = true;
        $msg.textContent = 'Verificando…';

        const email = /** @type {HTMLInputElement} */ (document.getElementById('email')).value.trim();
        const password = /** @type {HTMLInputElement} */ (document.getElementById('password')).value;

        try {
          const r = await fetch(API + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok || !d || d.ok !== true) throw new Error(d.error || 'Credenciales inválidas');

          // Verifica sesión
          const me = await fetch(API + '/auth/me', { credentials: 'include' });
          const md = await me.json().catch(() => ({}));
          if (me.ok && md && md.auth === true) {
            location.href = nextUrl;
          } else {
            throw new Error('No se pudo establecer sesión');
          }
        } catch (err) {
          console.error(err);
          $msg.textContent = 'Error: ' + (err?.message || 'No se pudo iniciar sesión');
          $btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
